meta {
  name: Add device
  type: http
  seq: 1
}

post {
  url: {{baseUrl}}/api/devices
  body: json
  auth: none
}

headers {
  Content-Type: application/json
  Accept: application/json
}

body:json {
  {
    "appVersion": "1.0.0",
    "key": {
      "type": "RSA_2048",
      "value": "{{deviceKey}}"
    },
    "metadata": {
      "brand": "Bruno",
      "manufacturer": "Bruno",
      "model": "Simulated Model",
      "osVersion": "Android: 13 - ROM: 5.4.210-qgki-25866952-abG990BXXU2EWAJ",
      "product": "r9qxxx",
      "devicePhysicalId": "35583C19",
      "industrialDesignName": "r9q"
    },
    "mobileNumber": {
      "countryCode": "{{countryCode}}",
      "number": "{{linkPhoneNumber}}"
    },
    "name": "BrunoDevice_{{$randomAlphaNumeric}}",
    "notifications": {
      "token": "cI4_TRUPT...",
      "platform": "FIREBASE"
    },
    "platform": "ANDROID"
  }
}

script:pre-request {
  bru.deleteAllVars();
  
  const crypto = require('crypto');
  const NodeRSA = require('node-rsa');
  
  bru.setGlobalEnvVar("deviceId", "");
  bru.setGlobalEnvVar("personId", "");
  bru.setGlobalEnvVar("businessId", "");
  
  const privateKeyPem = bru.getGlobalEnvVar("privateKeyPem");
  const publicKeyPem = bru.getGlobalEnvVar("publicKeyPem");
  const generateNewKeyPairString = bru.getCollectionVar("generateNewKeyPair");
  const generateNewKeyPair = (generateNewKeyPairString === "true");
  const pemHeader = "-----BEGIN PUBLIC KEY-----";
  const pemFooter = "-----END PUBLIC KEY-----";
  
  if ((!privateKeyPem || !publicKeyPem) || generateNewKeyPair) {
      console.log("Generating new RSA key pair...");
  
      const { publicKey, privateKey } = crypto.generateKeyPairSync('rsa', {
          modulusLength: 2048,
          publicKeyEncoding: {
              type: 'spki',
              format: 'pem',
          },
          privateKeyEncoding: {
              type: 'pkcs8',
              format: 'pem',
          },
      });
  
      const privateKeyPemString = privateKey.toString();
      const publicKeyPemString = publicKey.toString();
      const rawPublicKey = publicKeyPemString
      .replace(pemHeader, '')
      .replace(pemFooter, '')
      .replace(/\n/g, '');
  
      bru.setGlobalEnvVar('privateKeyPem', privateKeyPemString);
      bru.setGlobalEnvVar('publicKeyPem', publicKeyPemString);
      bru.setGlobalEnvVar('deviceKey', rawPublicKey);
  
      console.log(`\nKey value used when creating a new device: ${rawPublicKey}`);
  
  } else {
      console.log("Keys already exist. Reusing existing keys.");
      
      const publicKeyPemString = publicKeyPem.toString();
      const rawPublicKey = publicKeyPemString
      .replace(pemHeader, '')
      .replace(pemFooter, '')
      .replace(/\n/g, '');
  
      bru.setGlobalEnvVar('deviceKey', rawPublicKey);
  }
}

script:post-response {
  let responseData = res.getBody();
  bru.setVar("deviceId", responseData.deviceId);
  bru.setGlobalEnvVar("deviceId", responseData.deviceId);
}

settings {
  encodeUrl: true
  timeout: 0
}

docs {
  Add a device based on the information provided by a person.
  
  Returns `deviceId` which is required for most other actions relating to devices.
  
  You should fetch the registered device via the `Retrieve a device` API call to ensure the device is created.
  
}
